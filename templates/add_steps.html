<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Steps</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
</head>
<body>
    <div class="container">
        <div id="app">
            {% raw %}
            <div v-for="step in steps">
                <h2>{{ step.type }}</h2>
                <div :id="`plot_${step.id}`" style="height: 500px;"></div>
                <form :action="'/add_steps/' + step.dataset_id" method="post">
                    <div class="form-group">
                        <select name="type" id="type" class="form-control">
                            <option v-for="step_type in step_types" :value="step_type">{{ step_type }}</option>
                        </select>
                        <input type="submit" value="Add Step" class="btn btn-primary">
                    </div>
                </form>
            </div>
            {% endraw %}
        </div>
    </div>

    <script>
        window.serverData = {
            steps: [{% for step in steps %}{ id: {{ step.id }}, type: "{{ step.type }}", dataset_id: {{ step.dataset_id }}, plotHtml: "" }{% if not loop.last %}, {% endif %}{% endfor %}],
            step_types: [{% for step_type in step_types %}"{{ step_type }}"{% if not loop.last %}, {% endif %}{% endfor %}]
        };

        new Vue({
            el: '#app',
            data: {
                steps: window.serverData.steps,
                step_types: window.serverData.step_types
            },
            created() {
                this.loadPlot(0);
            },
            methods: {
                loadPlot: function (stepIndex) {
                    if (stepIndex >= this.steps.length) {
                        return;
                    }

                    const step = this.steps[stepIndex];
                    fetch('/get_plot/' + step.id)
                    .then(response => response.json())
                    .then(data => {
                        this.$nextTick(() => {
                            Plotly.newPlot(`plot_${step.id}`, data.data, data.layout);
                            this.loadPlot(stepIndex + 1);
                        });
                    })
                    .catch(error => console.log(error));
                }
            }
        });
    </script>
</body>
</html>
